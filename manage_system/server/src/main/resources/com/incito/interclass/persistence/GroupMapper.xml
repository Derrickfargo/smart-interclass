<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.incito.interclass.persistence.GroupMapper">
	<resultMap id="GroupMap" type="com.incito.interclass.entity.Group" >
	    <id column="id" property="id"/>
	    <result column="name" property="name"/>
	    <result column="logo" property="logo"/>
	    <result column="slogan" property="slogan"/>
	    <result column="course_id" property="courseId"/>
	    <result column="teacher_id" property="teacherId"/>
	    <result column="class_id" property="classId"/>
	    <result column="table_id" property="tableId"/>
	    <result column="ctime" property="ctime"/>
	</resultMap>
	
	<resultMap id="GroupUserMap" extends="GroupMap" type="com.incito.interclass.entity.Group" >
		<collection property="students" ofType="com.incito.interclass.entity.Student">  
		    <id column="id" property="id"/>
		    <result column="uname" property="uname"/>
		    <result column="password" property="password"/>
		    <result column="name" property="name"/>
		    <result column="email" property="email"/>
		    <result column="sex" property="sex"/>
		    <result column="is_active" property="isActive"/>
		    <result column="role" property="role"/>
		    <result column="ctime" property="ctime"/>
		    <result column="number" property="number"/>
		    <result column="avatar" property="avatar"/>
	    </collection>
	</resultMap>
  
	<select id="getGroupList" resultMap="GroupUserMap" parameterType="java.util.Map">
		SELECT	
			tb_group.id,tb_group.name,tb_group.logo,tb_group.slogan,
			tb_group.course_id AS courseId,tb_group.teacher_id AS teacherId,
			tb_group.class_id AS classId,tb_group.table_id AS tableId,tb_table.number AS tableNumber
		FROM 
			tb_group
		INNER JOIN 
			tb_teacher ON tb_teacher.id = tb_group.teacher_id
		INNER JOIN 
			tb_user ON tb_user.id = tb_teacher.id
		LEFT JOIN
			tb_course ON tb_course.id = tb_group.course_id
		LEFT JOIN
			tb_class ON tb_class.id = tb_group.class_id
		INNER JOIN
			tb_table ON tb_table.id = tb_group.table_id
		WHERE
			tb_user.id = #{teacherId}
			AND tb_class.id = #{classId}
			AND tb_course.id = #{courseId}
		ORDER BY
			id
	</select>

	<select id="getGroupByIMEI" resultMap="GroupUserMap" parameterType="java.util.Map">
		SELECT	
			tb_group.id,tb_group.name,tb_group.logo,tb_group.slogan,
			tb_group.course_id AS courseId,tb_group.teacher_id AS teacherId,
			tb_group.class_id AS classId,tb_group.table_id AS tableId,tb_table.number AS tableNumber
		FROM 
			tb_group
		INNER JOIN 
			tb_teacher ON tb_teacher.id = tb_group.teacher_id
		INNER JOIN 
			tb_user ON tb_user.id = tb_teacher.id
		INNER JOIN
			tb_course ON tb_course.id = tb_group.course_id
		INNER JOIN
			tb_class ON tb_class.id = tb_group.class_id
		INNER JOIN
			tb_table ON tb_table.id = tb_group.table_id
		INNER JOIN
			tb_device ON tb_device.table_id = tb_table.id
		WHERE
			tb_user.id = #{teacherId}
			AND tb_class.id = #{classId}
			AND tb_course.id = #{courseId}
			AND tb_device.imei = #{imei}
		ORDER BY
			id
	</select>
	
	<insert id="save" parameterType="com.incito.interclass.entity.Group" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO 
			tb_group(name,logo,slogan,course_id,teacher_id,class_id,ctime)
		VALUES
			(#{name},#{logo},#{slogan},#{courseId},#{teacherId},#{classId},now())
	</insert>
	
	<insert id="saveStudentGroup" parameterType="com.incito.interclass.entity.StudentGroup" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO 
			tb_student_group(student_id,group_id)
		VALUES
			(#{studentId},#{groupId})
	</insert>
	
	<delete id="delete" parameterType="java.lang.Integer">
		DELETE FROM tb_group WHERE id = #{id} 
	</delete>
</mapper>